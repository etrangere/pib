<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="jsonStorage.js"></script>
    <script src="common.js"></script>

    <title>Sprint Planning</title>
</head>

<body>
<div>
    <label for="step3">Step 3 -> select the checkbox to trigger progress bar increment:</label>
    <input type="checkbox" id="step3" name="step3" onchange="updateProgressBar('step3')">
</div>
<h1>Sprint Planning</h1>
<p>To conclude, sprint planning is an essential agile ceremony of the scrum team which aims to determine the content and organization of the next sprint in order to achieve a common goal for all and generate value for the user. In practice, it mainly requires preparation work to be effective, but this ceremony is not as fixed as one might think. Thus, it is rather necessary to see the sprint planning as part of a tool allowing to deliver value and this tool is to be evolved according to the experience of your team.</p>
<div id="textarea-container">
    <p>
        <textarea   rows="5" cols="110"></textarea>
    </p>
</div>

</body>
</html>
<script>

    // Define the increment value
    let incrementValue = 13; // Set the initial value
    //Change value with method selection
    (async function initializeMethod() {
        const methoddev = await jsonStorage.getItem("val");
        if (methoddev === "Kanban") {
            incrementValue = 33;
        }
    })();


    // Function to update the progress bar and save the value
    async function updateProgressBar(stepId) {
        // Get the step checkbox by its ID
        const stepCheckbox = document.getElementById(stepId);

        // Check if the step checkbox element exists
        if (!stepCheckbox) {
            console.error("Step checkbox not found!");
            return;
        }

        // Calculate the progress increment
        const progressIncrement = stepCheckbox.checked ? incrementValue : -incrementValue;

        // Retrieve the overall progress value from jsonStorage
        const savedProgress = await jsonStorage.getItem("progress");
        let overallProgress = 0;

        if (savedProgress && !isNaN(savedProgress)) {
            overallProgress = parseInt(savedProgress, 10);
        }

        // Update the overall progress by adding the current progress increment
        overallProgress += progressIncrement;

        // Save the overall progress value to jsonStorage
        await jsonStorage.setItem("progress", overallProgress.toString());

        // Save the checked state of the step checkbox to jsonStorage
        await jsonStorage.setItem(stepId, stepCheckbox.checked ? "checked" : "unchecked");

        // Update the width of the progress bar
        const progressBar = document.getElementById("myBar");
        if (progressBar) {
            progressBar.style.width = overallProgress + "%";
        }
    }

    // Check if progress value exists in jsonStorage on page load
    document.addEventListener("DOMContentLoaded", async function() {
        // Retrieve the overall progress value from jsonStorage
        const savedProgress = await jsonStorage.getItem("progress");
        let overallProgress = 0;

        if (savedProgress && !isNaN(savedProgress)) {
            overallProgress = parseInt(savedProgress, 10);
        }

        // Get the step checkbox by its ID
        const stepCheckbox = document.getElementById("step3");

        // Check if the step checkbox element exists
        if (!stepCheckbox) {
            console.error("Step checkbox not found!");
            return;
        }

        // Retrieve the checked state of the step checkbox from jsonStorage
        const savedCheckboxValue = await jsonStorage.getItem("step3");
        if (savedCheckboxValue === "checked") {
            stepCheckbox.checked = true;
            overallProgress += incrementValue;
        } else {
            stepCheckbox.checked = false;
        }

        // Update the width of the progress bar with the overall progress value
        const progressBar = document.getElementById("myBar");
        if (progressBar) {
            progressBar.style.width = overallProgress + "%";
        }
    });
</script>
<script>
    const textareaContainer = document.getElementById("textarea-container");
    const textareas = textareaContainer.getElementsByTagName("textarea");
    const checkboxes = textareaContainer.querySelectorAll("input[type='checkbox']");
    let formValues = {};
    let counter = 0; // initialize counter variable

    for (let i = 0; i < textareas.length + checkboxes.length; i++) {
        if (i < textareas.length) {
            const textarea = textareas[i];
            const id = prefix + (counter + 1);
            textarea.id = id;
            formValues[id] = textarea.value;
            // Rendre la fonction callback async
            textarea.addEventListener("input", async (event) => { // <-- async
                formValues[id] = event.target.value;
                // Utiliser await pour s'assurer que l'opération est terminée
                await jsonStorage.setItem("formValues", JSON.stringify(formValues)); // <-- await
                // console.log("Textarea value saved for ID:", id); // Pour le débogage
            });
            counter++; // increment counter variable
        } else {
            const checkbox = checkboxes[i - textareas.length];
            const id = prefix + (counter + 1);
            checkbox.id = id;
            formValues[id] = checkbox.checked;
            // Rendre la fonction callback async
            checkbox.addEventListener("change", async (event) => { // <-- async
                formValues[id] = event.target.checked;
                // Utiliser await pour s'assurer que l'opération est terminée
                await jsonStorage.setItem("formValues", JSON.stringify(formValues)); // <-- await
                // console.log("Checkbox state saved for ID:", id); // Pour le débogage
            });
            counter++; // increment counter variable
        }
    }

    // Wrap in async IIFE to use await
    (async () => {
        const savedFormValues = await jsonStorage.getItem("formValues");
        if (savedFormValues) {
            formValues = JSON.parse(savedFormValues);
            for (const id in formValues) {
                if (formValues.hasOwnProperty(id)) {
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.tagName === "TEXTAREA") {
                            element.value = formValues[id];
                        } else if (element.tagName === "INPUT" && element.type === "checkbox") {
                            element.checked = formValues[id];
                        }
                    } else {
                        console.warn(`Element with id "${id}" not found on page`);
                    }
                }
            }
        }
    })();

    const updateButton = document.getElementById("update-button-all");
    if (updateButton) {
        updateButton.addEventListener("click", async () => {
            for (let i = 0; i < textareas.length + checkboxes.length; i++) {
                const id = prefix + (i + 1);
                const element = document.getElementById(id);
                if (element) {
                    if (element.tagName === "TEXTAREA") {
                        formValues[id] = element.value;
                    } else if (element.tagName === "INPUT" && element.type === "checkbox") {
                        formValues[id] = element.checked;
                    }
                } else {
                    console.warn(`Element with id "${id}" not found on page`);
                }
            }
            await jsonStorage.setItem("formValues", JSON.stringify(formValues));
            alert("Values updated!");
        });
    } else {
        // console.warn("Update button 'update-button-all' not found.");
    }
</script>
<script src="script.js"></script>