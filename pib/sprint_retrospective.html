<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script>
        // --- Global variables ---
        window.prefix = null;
        window.baseUrl = null;

        // --- Step 1: Normalize path and compute prefix (remove .html) ---
        const pathname = window.location.pathname.replace(/\/{2,}/g, '/');
        window.prefix = pathname.replace('.html', '');

        // --- Step 2: Extract project name for title ---
        const segments = pathname.split('/').filter(s => s);
        const pibIndex = segments.indexOf('pib');
        const projectName = pibIndex > 0
            ? segments[pibIndex - 1]
            : segments[0] || 'PIB';

        // --- Step 3: Set dynamic page title ---
        document.title = `${projectName}_pib`;

        // --- Step 4: Fetch real server port ---
        fetch('./server-control.php?cmd=status')
            .then(response => {
                if (!response.ok) throw new Error('Network error: ' + response.status);
                return response.json();
            })
            .then(data => {
                // Use real port from PHP server
                const port = data.port || 8088;

                // ✅ Build baseUrl with correct protocol + port + prefix
                window.baseUrl = `http://localhost:${port}${window.prefix}`;

                // ✅ Debug
                console.log('Project:', projectName);
                console.log('prefix:', window.prefix);
                console.log('Port:', port);
                console.log('Base URL:', window.baseUrl);
            })
            .catch(err => {
                // ✅ Fallback if API fails

            });
    </script>

    <title>Sprint retrospective</title>
</head>

<body>
<div><label for="step8">Step 8 -> select the checkbox to trigger progress bar increment:</label>
    <input type="checkbox" id="step8" name="step8" onchange="updateProgressBar('step8')">
</div>

<h1>Sprint retrospective</h1>

<p>The retrospective sprint is the Scrum ceremony at the end of the Sprint which takes place just after the Sprint Review. Indeed, the sprint closes just at the end of this ceremony. It offers the entire scrum team the opportunity to put in place areas for improvement for the next sprints.</p>
<div id="textarea-container">
    <p>
        <textarea   rows="5" cols="110"></textarea>
    </p>
</div>

</body>
</html>
<script>

    // Define the increment value
    let incrementValue = 12; // Set the initial value
    //Change value with method selection
    (async function initializeMethod() {
        const methoddev = await jsonStorage.getItem("val");
        if (methoddev === "Kanban") {
            incrementValue = 33;
        }
    })();


    // Function to update the progress bar and save the value
    async function updateProgressBar(stepId) {
        // Get the step checkbox by its ID
        const stepCheckbox = document.getElementById(stepId);

        // Check if the step checkbox element exists
        if (!stepCheckbox) {
            console.error("Step checkbox not found!");
            return;
        }

        // Calculate the progress increment
        const progressIncrement = stepCheckbox.checked ? incrementValue : -incrementValue;

        // Retrieve the overall progress value from jsonStorage
        const savedProgress = await jsonStorage.getItem("progress");
        let overallProgress = 0;

        if (savedProgress && !isNaN(savedProgress)) {
            overallProgress = parseInt(savedProgress, 10);
        }

        // Update the overall progress by adding the current progress increment
        overallProgress += progressIncrement;

        // Save the overall progress value to jsonStorage
        await jsonStorage.setItem("progress", overallProgress.toString());

        // Save the checked state of the step checkbox to jsonStorage
        await jsonStorage.setItem(stepId, stepCheckbox.checked ? "checked" : "unchecked");

        // Update the width of the progress bar
        const progressBar = document.getElementById("myBar");
        if (progressBar) {
            progressBar.style.width = overallProgress + "%";
        }
    }

    // Check if progress value exists in jsonStorage on page load
    document.addEventListener("DOMContentLoaded", async function() {
        // Retrieve the overall progress value from jsonStorage
        const savedProgress = await jsonStorage.getItem("progress");
        let overallProgress = 0;

        if (savedProgress && !isNaN(savedProgress)) {
            overallProgress = parseInt(savedProgress, 10);
        }

        // Get the step checkbox by its ID
        const stepCheckbox = document.getElementById("step8");

        // Check if the step checkbox element exists
        if (!stepCheckbox) {
            console.error("Step checkbox not found!");
            return;
        }

        // Retrieve the checked state of the step checkbox from jsonStorage
        const savedCheckboxValue = await jsonStorage.getItem("step8");
        if (savedCheckboxValue === "checked") {
            stepCheckbox.checked = true;
            overallProgress += incrementValue;
        } else {
            stepCheckbox.checked = false;
        }

        // Update the width of the progress bar with the overall progress value
        const progressBar = document.getElementById("myBar");
        if (progressBar) {
            progressBar.style.width = overallProgress + "%";
        }
    });
</script>
<script>
    const textareaContainer = document.getElementById("textarea-container");
    const textareas = textareaContainer.getElementsByTagName("textarea");
    const checkboxes = textareaContainer.querySelectorAll("input[type='checkbox']");
    let formValues = {};
    let counter = 0; // initialize counter variable

    for (let i = 0; i < textareas.length + checkboxes.length; i++) {
        if (i < textareas.length) {
            const textarea = textareas[i];
            const id = prefix + (counter + 1);
            textarea.id = id;
            formValues[id] = textarea.value;
            // Rendre la fonction callback async
            textarea.addEventListener("input", async (event) => { // <-- async
                formValues[id] = event.target.value;
                // Utiliser await pour s'assurer que l'opération est terminée
                await jsonStorage.setItem("formValues", JSON.stringify(formValues)); // <-- await
                // console.log("Textarea value saved for ID:", id); // Pour le débogage
            });
            counter++; // increment counter variable
        } else {
            const checkbox = checkboxes[i - textareas.length];
            const id = prefix + (counter + 1);
            checkbox.id = id;
            formValues[id] = checkbox.checked;
            // Rendre la fonction callback async
            checkbox.addEventListener("change", async (event) => { // <-- async
                formValues[id] = event.target.checked;
                // Utiliser await pour s'assurer que l'opération est terminée
                await jsonStorage.setItem("formValues", JSON.stringify(formValues)); // <-- await
                // console.log("Checkbox state saved for ID:", id); // Pour le débogage
            });
            counter++; // increment counter variable
        }
    }

    // Wrap in async IIFE to use await
    (async () => {
        const savedFormValues = await jsonStorage.getItem("formValues");
        if (savedFormValues) {
            formValues = JSON.parse(savedFormValues);
            for (const id in formValues) {
                if (formValues.hasOwnProperty(id)) {
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.tagName === "TEXTAREA") {
                            element.value = formValues[id];
                        } else if (element.tagName === "INPUT" && element.type === "checkbox") {
                            element.checked = formValues[id];
                        }
                    } else {
                        console.warn(`Element with id "${id}" not found on page`);
                    }
                }
            }
        }
    })();

    const updateButton = document.getElementById("update-button-all");
    if (updateButton) {
        updateButton.addEventListener("click", async () => {
            for (let i = 0; i < textareas.length + checkboxes.length; i++) {
                const id = prefix + (i + 1);
                const element = document.getElementById(id);
                if (element) {
                    if (element.tagName === "TEXTAREA") {
                        formValues[id] = element.value;
                    } else if (element.tagName === "INPUT" && element.type === "checkbox") {
                        formValues[id] = element.checked;
                    }
                } else {
                    console.warn(`Element with id "${id}" not found on page`);
                }
            }
            await jsonStorage.setItem("formValues", JSON.stringify(formValues));
            alert("Values updated!");
        });
    } else {
        // console.warn("Update button 'update-button-all' not found.");
    }
</script>
<script src="script.js"></script>